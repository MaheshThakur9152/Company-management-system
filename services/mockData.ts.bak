
import { Employee, Invoice, Site, AttendanceRecord, DashboardStats, InvoiceItem, ManualLedgerEntry, SalaryRecord } from '../types';

export const MOCK_SITES: Site[] = [
  { 
    id: 's1', 
    name: 'Min_CHS (Sales Office)', 
    location: 'Minerva Building, Mumbai', 
    activeWorkers: 7,
    latitude: 18.995, 
    longitude: 72.82,
    geofenceRadius: 200,
    clientName: 'Minerva Estate',
    clientContact: '+91 98765 43210'
  },
  { 
    id: 's2', 
    name: 'Minerva Ho', 
    location: 'Minerva Head Office, Mumbai', 
    activeWorkers: 8,
    latitude: 18.996, 
    longitude: 72.821,
    geofenceRadius: 200,
    clientName: 'Minerva Group',
    clientContact: '+91 98765 43211'
  },
  { 
    id: 's3', 
    name: 'Royal Eksar', 
    location: 'Eksar Road, Borivali', 
    activeWorkers: 2,
    latitude: 19.24, 
    longitude: 72.85,
    geofenceRadius: 200,
    clientName: 'Royal Group',
    clientContact: '+91 98765 43212'
  },
  { 
    id: 's4', 
    name: 'Ceejay', 
    location: 'Worli, Mumbai', 
    activeWorkers: 4,
    latitude: 19.00, 
    longitude: 72.81,
    geofenceRadius: 200,
    clientName: 'Ceejay House Mgmt',
    clientContact: '+91 98765 43213'
  },
  { 
    id: 's5', 
    name: 'Sanjay puri', 
    location: 'Andheri West, Mumbai', 
    activeWorkers: 2,
    latitude: 19.13, 
    longitude: 72.83,
    geofenceRadius: 200,
    clientName: 'Sanjay Puri Architects',
    clientContact: '+91 98765 43214'
  },
  { 
    id: 's6', 
    name: 'Ruparel Elara', 
    location: 'Dadar West, Mumbai', 
    activeWorkers: 3,
    latitude: 19.02, 
    longitude: 72.84,
    geofenceRadius: 200,
    clientName: 'Elara Capital',
    clientContact: '+91 98765 43215'
  },
  { 
    id: 's7', 
    name: 'Ajmera', 
    location: 'Mumbai', 
    activeWorkers: 4,
    latitude: 19.02, 
    longitude: 72.84,
    geofenceRadius: 200,
    clientName: 'Ajmera Group',
    clientContact: '+91 98765 43216'
  },
  { 
    id: 's8', 
    name: 'ACME', 
    location: 'Mumbai', 
    activeWorkers: 9,
    latitude: 19.02, 
    longitude: 72.84,
    geofenceRadius: 200,
    clientName: 'Acme Group',
    clientContact: '+91 98765 43217'
  },
  { 
    id: 's9', 
    name: 'Shreeya', 
    location: 'Mumbai', 
    activeWorkers: 5,
    latitude: 19.05, 
    longitude: 72.85,
    geofenceRadius: 200,
    clientName: 'Shreeya Group',
    clientContact: '+91 98765 43218'
  },
  { 
    id: 's10', 
    name: 'Ambe Office', 
    location: 'Mumbai', 
    activeWorkers: 1,
    latitude: 19.06, 
    longitude: 72.86,
    geofenceRadius: 200,
    clientName: 'Ambe Office',
    clientContact: '+91 98765 43219'
  },
  { 
    id: 's11', 
    name: 'Common Washroom', 
    location: 'Mumbai', 
    activeWorkers: 2,
    latitude: 19.07, 
    longitude: 72.87,
    geofenceRadius: 200,
    clientName: 'Common Washroom',
    clientContact: '+91 98765 43220'
  },
  { 
    id: 's12', 
    name: 'Min_LO (Sales Office)', 
    location: 'Mumbai', 
    activeWorkers: 4,
    latitude: 19.08, 
    longitude: 72.88,
    geofenceRadius: 200,
    clientName: 'Minerva LO',
    clientContact: '+91 98765 43221'
  },
  { 
    id: 's13', 
    name: 'Palacio', 
    location: 'Mumbai', 
    activeWorkers: 4,
    latitude: 19.09, 
    longitude: 72.89,
    geofenceRadius: 200,
    clientName: 'Palacio',
    clientContact: '+91 98765 43222'
  },
  { 
    id: 's14', 
    name: 'BP Infra', 
    location: 'Mumbai', 
    activeWorkers: 8,
    latitude: 19.10, 
    longitude: 72.90,
    geofenceRadius: 200,
    clientName: 'BP Infra',
    clientContact: '+91 98765 43223'
  },
  { 
    id: 's15', 
    name: 'Min_SALES OFFICE', 
    location: 'Mumbai', 
    activeWorkers: 7,
    latitude: 19.11, 
    longitude: 72.91,
    geofenceRadius: 200,
    clientName: 'Minerva Sales',
    clientContact: '+91 98765 43224'
  },
  { 
    id: 's16', 
    name: 'AMBE-ROUNDER', 
    location: 'Mumbai', 
    activeWorkers: 2,
    latitude: 19.12, 
    longitude: 72.92,
    geofenceRadius: 200,
    clientName: 'Ambe Rounder',
    clientContact: '+91 98765 43225'
  }
];

// Helper to generate employees
const createEmp = (id: string, code: string, name: string, siteId: string, role: any = 'Janitor', baseSalary: number = 15000, isDailyRated: boolean = false): Employee => ({
  id, biometricCode: code, name, role, siteId, 
  photoUrl: `https://ui-avatars.com/api/?name=${name.replace(' ', '+')}&background=random`, 
  weeklyOff: 'Sunday', status: 'Active', joiningDate: '2025-01-01',
  salaryDetails: {
    baseSalary: baseSalary,
    isDailyRated: isDailyRated,
    dailyRateOverride: isDailyRated ? baseSalary : 0, // If daily rated, baseSalary param is treated as daily rate
    deductionBreakdown: {
        advance: 0,
        uniform: 0,
        shoes: 0,
        idCard: 0,
        cbre: 0,
        others: 0
    },
    // Legacy fields
    basic: baseSalary * 0.6,
    hra: baseSalary * 0.2,
    conveyance: baseSalary * 0.1,
    allowances: baseSalary * 0.1,
    deductions: 0,
    netSalary: baseSalary,
    paymentType: isDailyRated ? 'Daily' : 'Monthly'
  }
});

export const MOCK_EMPLOYEES: Employee[] = [
  // Site 3: Royal Eksar
  createEmp('e301', '3001', 'Jayanti', 's3', 'Janitor', 11000),
  createEmp('e302', '3002', 'Leela', 's3', 'Janitor', 11000),

  // Site 9: Shreeya
  createEmp('e901', '9001', 'Sharda', 's9', 'Janitor', 10500),
  createEmp('e902', '9002', 'Reshma', 's9', 'Janitor', 10500),
  createEmp('e903', '9003', 'Najiya', 's9', 'Janitor', 10500),
  createEmp('e904', '9004', 'Hussain', 's9', 'Janitor', 10500),
  createEmp('e905', '9005', 'Kamalbai', 's9', 'Janitor', 10500),

  // Site 10: Ambe Office
  createEmp('e1001', '10001', 'Umang', 's10', 'Staff', 15000),

  // Site 6: Ruparel Elra
  createEmp('e601', '6001', 'Uttam Mishra', 's6', 'Janitor', 20000),
  createEmp('e604', '6004', 'Sudhakar', 's6', 'Janitor', 11000),
  createEmp('e602', '6002', 'Pravin', 's6', 'Janitor', 12000),

  // Site 11: Common Washroom
  createEmp('e402', '4002', 'Nuri', 's11', 'Janitor', 11000),
  createEmp('e401', '4001', 'Saddam', 's11', 'Janitor', 13000),

  // Site 1: Min_CHS (Sales Office)
  createEmp('e104', '1004', 'Rahul', 's1', 'Janitor', 14000),
  createEmp('e102', '1002', 'Firoj md', 's1', 'Janitor', 14000),
  createEmp('e101', '1001', 'Omkar Gothankar', 's1', 'Key Supervisor', 16000),
  createEmp('e103', '1003', 'Pradeep', 's1', 'Janitor', 16000),
  createEmp('e106', '1006', 'Kanhaiyalal', 's1', 'Janitor', 17000),
  createEmp('e109', '1009', 'Sandeep', 's1', 'Janitor', 12500),
  createEmp('e108', '1008', 'Divya Shinde', 's1', 'Janitor', 12500),

  // Site 4: Ceejay
  createEmp('e404', '4004', 'Ranjan', 's4', 'Janitor', 13000),
  createEmp('e406', '4006', 'Santosh', 's4', 'Janitor', 13000),
  createEmp('e405', '4005', 'Gangaram', 's4', 'Janitor', 13000),
  createEmp('e403', '4003', 'Niraj', 's4', 'Pantry', 16000),

  // Site 12: Min_LO (Sales Office)
  createEmp('e1201', '12001', 'Priyeh Singh', 's12', 'Janitor', 15000),
  createEmp('e1202', '12002', 'Sudhir', 's12', 'Janitor', 15000),
  createEmp('e1203', '12003', 'Shivshankar', 's12', 'Janitor', 15000),
  createEmp('e1204', '12004', 'Manoj', 's12', 'Janitor', 15000),

  // Site 13: Palacio
  createEmp('e1301', '13001', 'Laxman', 's13', 'Janitor', 14000),
  createEmp('e1302', '13002', 'Archana', 's13', 'Janitor', 12500),
  createEmp('e1303', '13003', 'Sanju', 's13', 'Janitor', 12500),
  createEmp('e1304', '13004', 'Ravi', 's13', 'Janitor', 12500),

  // Site 8: ACME
  createEmp('e807', '8007', 'Saraswati', 's8', 'Housekeeping', 12000),
  createEmp('e802', '8002', 'Maruti', 's8', 'Housekeeping', 12000),
  createEmp('e808', '8008', 'Sagar', 's8', 'Housekeeping', 12000),
  createEmp('e809', '8009', 'Babu', 's8', 'Housekeeping', 12000),
  createEmp('e810', '8010', 'Sandesh', 's8', 'Housekeeping', 12000),
  createEmp('e811', '8011', 'Bharti', 's8', 'Housekeeping', 12000),
  createEmp('e801', '8001', 'Asha', 's8', 'Housekeeping', 12000),
  createEmp('e812', '8012', 'Kiran', 's8', 'Housekeeping', 12000),
  createEmp('e813', '8013', 'Rashika', 's8', 'Housekeeping', 14000),

  // Site 14: BP Infra
  createEmp('e1401', '14001', 'Swati', 's14', 'Janitor', 13000),
  createEmp('e1402', '14002', 'Nisha Galfade', 's14', 'Janitor', 11000),
  createEmp('e1403', '14003', 'Nisha Singh', 's14', 'Janitor', 11000),
  createEmp('e1404', '14004', 'Aarti', 's14', 'Janitor', 11000),
  createEmp('e1405', '14005', 'Vijay', 's14', 'Janitor', 11000),
  createEmp('e1406', '14006', 'Joyti', 's14', 'Janitor', 11000),
  createEmp('e1407', '14007', 'Sunita', 's14', 'Janitor', 11000),
  createEmp('e1408', '14008', 'Sakku Bai', 's14', 'Janitor', 11000),

  // Site 15: Min_SALES OFFICE
  createEmp('e1501', '15001', 'Khairunisha', 's15', 'Janitor', 15000),
  createEmp('e1502', '15002', 'Shabnam', 's15', 'Janitor', 0, true), // Daily rated
  createEmp('e1503', '15003', 'Omkar Patil', 's15', 'Janitor', 12500),
  createEmp('e1504', '15004', 'Vinit', 's15', 'Janitor', 14000),
  createEmp('e1505', '15005', 'Sagar', 's15', 'Janitor', 12500),
  createEmp('e1506', '15006', 'Arif', 's15', 'Janitor', 12500),
  createEmp('e1507', '15007', 'Premanand', 's15', 'Janitor', 15000),

  // Site 16: AMBE-ROUNDER
  createEmp('e1601', '16001', 'Abhishesh', 's16', 'Rounder', 20000),
  createEmp('e806', '8006', 'Mohit', 's16', 'Rounder', 20500), // Moved from ACME

  // Keeping other existing employees for sites not mentioned in update
  // Site 2: Minerva Ho
  createEmp('e201', '2001', 'Aalim', 's2'),
  createEmp('e202', '2002', 'Rehana', 's2'),
  createEmp('e203', '2003', 'Asma', 's2'),
  createEmp('e204', '2004', 'Shakila', 's2'),
  createEmp('e205', '2005', 'Amola khatoon', 's2'),
  createEmp('e206', '2006', 'aphasana', 's2'),
  createEmp('e207', '2007', 'Rehana banu', 's2'),
  createEmp('e208', '2008', 'Ruksana', 's2'),

  // Site 5: Sanjay puri
  createEmp('e501', '5001', 'Mallesh', 's5'),
  createEmp('e502', '5002', 'gudu', 's5'),

  // Site 7: Ajmera
  createEmp('e701', '7001', 'Vinod', 's7', 'Housekeeping'),
  createEmp('e702', '7002', 'Pravin', 's7', 'Housekeeping'),
  createEmp('e703', '7003', 'Balaram', 's7', 'Housekeeping'),
  createEmp('e704', '7004', 'Vijay', 's7', 'Housekeeping'),
];

export const MOCK_INVOICES: Invoice[] = [
  { 
    id: 'inv1', 
    invoiceNo: 'ASF/P/25-26/026', 
    siteId: 's1', 
    siteName: 'Minerva 9th floor', 
    billingPeriod: 'Oct 2025', 
    amount: 59000, 
    subTotal: 50000,
    managementRate: 7,
    managementAmount: 3500, 
    materialCharges: 0,
    taxableAmount: 50000, 
    cgst: 4500,
    sgst: 4500,
    status: 'Unpaid', 
    dueDate: '2025-11-15', 
    generatedDate: '2025-11-01',
    items: [
      { id: '1', description: 'Manpower Services', hsn: '9985', rate: 25000, days: 30, persons: 2, amount: 50000 }
    ]
  },
];

export const MOCK_STATS: DashboardStats = {
  totalUnpaid: 59000,
  activeSites: MOCK_SITES.length,
  totalWorkers: MOCK_EMPLOYEES.length,
  revenue: 1850000
};

export const CHART_DATA = [
  { name: 'Jul', revenue: 120000 },
  { name: 'Aug', revenue: 150000 },
  { name: 'Sep', revenue: 180000 },
  { name: 'Oct', revenue: 140000 },
  { name: 'Nov', revenue: 185000 },
];

// --- Simulated Backend Logic using LocalStorage (FALLBACK) ---
// REPLACED WITH REAL BACKEND API CALLS

const API_URL = 'http://localhost:3000/api'; // Use localhost for Web

async function apiCall<T>(endpoint: string, method: string = 'GET', body?: any): Promise<T> {
    try {
        const headers: any = { 'Content-Type': 'application/json' };
        const config: any = { method, headers };
        if (body) config.body = JSON.stringify(body);
        
        const response = await fetch(`${API_URL}${endpoint}`, config);
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        return await response.json();
    } catch (error) {
        console.warn(`API Call Failed (${endpoint})`, error);
        throw error;
    }
}

export const getSharedAttendanceData = async (): Promise<AttendanceRecord[]> => {
    try {
        return await apiCall<AttendanceRecord[]>('/attendance');
    } catch (e) {
        return [];
    }
};

export const syncAttendanceData = async (localRecords: AttendanceRecord[]): Promise<boolean> => {
    try {
        await apiCall('/attendance/sync', 'POST', localRecords);
        return true;
    } catch (e) {
        return false;
    }
};

export const updateAttendanceRecord = async (record: AttendanceRecord): Promise<boolean> => {
    try {
        await apiCall('/attendance/sync', 'POST', [record]);
        return true;
    } catch (e) {
        return false;
    }
};

// --- INVOICES ---
export const getInvoices = async (): Promise<Invoice[]> => {
    try {
        return await apiCall<Invoice[]>('/invoices');
    } catch (e) {
        return MOCK_INVOICES;
    }
};

export const addInvoice = async (invoice: Invoice): Promise<boolean> => {
    try {
        await apiCall('/invoices', 'POST', invoice);
        return true;
    } catch (e) {
        return false;
    }
};

export const updateInvoice = async (updatedInvoice: Invoice): Promise<boolean> => {
    try {
        await apiCall(`/invoices/${updatedInvoice.id}`, 'PUT', updatedInvoice);
        return true;
    } catch (e) {
        return false;
    }
};

// --- EMPLOYEES ---
export const getEmployees = async (): Promise<Employee[]> => {
    try {
        return await apiCall<Employee[]>('/employees');
    } catch (e) {
        return MOCK_EMPLOYEES;
    }
};

export const addEmployee = async (employee: Employee): Promise<boolean> => {
    try {
        await apiCall('/employees', 'POST', employee);
        return true;
    } catch (e) {
        return false;
    }
};

export const updateEmployee = async (employee: Employee): Promise<boolean> => {
    try {
        await apiCall(`/employees/${employee.id}`, 'PUT', employee);
        return true;
    } catch (e) {
        return false;
    }
};

export const deleteEmployee = async (id: string): Promise<boolean> => {
    try {
        const emps = await getEmployees();
        const emp = emps.find(e => e.id === id);
        if (emp) {
            emp.status = 'Deleted';
            await updateEmployee(emp);
        }
        return true;
    } catch (e) {
        return false;
    }
};

// --- SITES ---
export const getSites = async (): Promise<Site[]> => {
    try {
        return await apiCall<Site[]>('/sites');
    } catch (e) {
        return MOCK_SITES;
    }
};

export const addSite = async (site: Site): Promise<boolean> => {
    try {
        await apiCall('/sites', 'POST', site);
        return true;
    } catch (e) {
        return false;
    }
};

export const updateSite = async (site: Site): Promise<boolean> => {
    try {
        await apiCall(`/sites/${site.id}`, 'PUT', site);
        return true;
    } catch (e) {
        return false;
    }
};

export const deleteSite = async (id: string): Promise<boolean> => {
    try {
        const sites = await getSites();
        const site = sites.find(s => s.id === id);
        if (site) {
            site.status = 'Deleted';
            await updateSite(site);
        }
        return true;
    } catch (e) {
        return false;
    }
};

// --- MANUAL LEDGER ENTRIES ---
export const getManualLedgerEntries = async (): Promise<ManualLedgerEntry[]> => {
    try {
        const data = localStorage.getItem('server_ledger_db_v3');
        return data ? JSON.parse(data) : [];
    } catch (e) {
        return [];
    }
};

export const addManualLedgerEntry = async (entry: ManualLedgerEntry): Promise<boolean> => {
    try {
        const current = await getManualLedgerEntries();
        current.push(entry);
        localStorage.setItem('server_ledger_db_v3', JSON.stringify(current));
        return true;
    } catch (e) {
        return false;
    }
};

export const updateManualLedgerEntry = async (entry: ManualLedgerEntry): Promise<boolean> => {
    try {
        const current = await getManualLedgerEntries();
        const updated = current.map(e => e.id === entry.id ? entry : e);
        localStorage.setItem('server_ledger_db_v3', JSON.stringify(updated));
        return true;
    } catch (e) {
        return false;
    }
};

export const deleteManualLedgerEntry = async (id: string): Promise<boolean> => {
    try {
        const current = await getManualLedgerEntries();
        const updated = current.filter(e => e.id !== id);
        localStorage.setItem('server_ledger_db_v3', JSON.stringify(updated));
        return true;
    } catch (e) {
        return false;
    }
};

// --- SALARY RECORDS ---
export const getSalaryRecords = async (): Promise<SalaryRecord[]> => {
    const data = localStorage.getItem('salary_records_db');
    return data ? JSON.parse(data) : [];
};

export const updateSalaryRecord = async (record: SalaryRecord): Promise<boolean> => {
    const current = await getSalaryRecords();
    const index = current.findIndex(r => r.id === record.id);
    if (index >= 0) {
        current[index] = record;
    } else {
        current.push(record);
    }
    localStorage.setItem('salary_records_db', JSON.stringify(current));
    return true;
};

